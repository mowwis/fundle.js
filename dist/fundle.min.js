class Component extends HTMLElement{bindings={};static tagName=null;static template=null;#t;#e=()=>this.render();#s=()=>this.remove();get model(){return this.#t}set model(t){if(this.#t&&(this.#t.removeEventListener(ModelEvent.CHANGE,this.#e),this.#t.removeEventListener(ModelEvent.DELETE,this.#s)),!t instanceof Model)throw new Error("The model must be an instance of Model.");this.#t=t,this.#t&&(this.#t.addEventListener(ModelEvent.CHANGE,this.#e),this.#t.addEventListener(ModelEvent.DELETE,this.#s))}#i;#n=()=>this.render();get collection(){return this.#i}set collection(t){if(this.#i&&(this.#i.removeEventListener(ModelEvent.NEW,this.#n),this.#i.removeEventListener(ModelEvent.CHANGE,this.#n)),!t instanceof Collection)throw new Error("The collection must be an instance of Collection.");this.#i=t,this.#i&&(this.#i.addEventListener(ModelEvent.NEW,this.#n),this.#i.addEventListener(ModelEvent.CHANGE,this.#n))}render(){Templater.bind(this,this.bindings)}connectedCallback(){if(this.constructor.template){this.innerHTML="";const t=Templater.clone(this.constructor.template);this.appendChild(t)}this.render()}disconnectedCallback(){this.model=null,this.collection=null}static define(t){this.tagName=t,customElements.define(t,this)}static new(t,e){if(!this.tagName)throw new Error("Component has no tagName defined. Call .define(tagName) first.");const s=document.createElement(this.tagName);return t?s.model=t:e&&(s.collection=e),s}}class Collection extends EventTarget{#a=[];#e=t=>this.dispatchEvent(ModelEvent.change(t.detail.target,t.detail.delta));constructor(t,...e){super(),this.modelClass=t,e.forEach((t=>this.push(t))),t.addEventListener("new",(t=>this.push(t.detail)))}fromArray(t){return t.forEach((t=>this.push(t))),this}push(t){t instanceof this.modelClass||(t=new this.modelClass(t)),this.includes(t)||(t.addEventListener("delete",(e=>this.remove(t))),t.addEventListener("change",this.#e),this.#a.push(t),this.dispatchEvent(ModelEvent.new(t)))}remove(t){const e=this.indexOf(t);-1!==e&&(t.removeEventListener("change",this.#e),this.splice(e,1),this.dispatchEvent(ModelEvent.delete(t)))}sort(t){return this.#a.sort(t)}indexOf(t,e){return this.#a.indexOf(t,e)}includes(t,e){return this.#a.includes(t,e)}forEach(t){this.#a.forEach(t)}map(t){return new Collection(this.modelClass).fromArray(this.#a.map(t))}filter(t){return new Collection(this.modelClass).fromArray(this.#a.filter(t))}splice(t,e){return new Collection(this.modelClass).fromArray(this.#a.splice(t,e))}flatMap(t){return new Collection(this.modelClass).fromArray(this.#a.flatMap(t))}}class Model extends EventTarget{static fields={};static endpoint=null;static _instanceCache=new Map;static _classEventTarget=new EventTarget;fieldChanges={};get changeDelta(){return Object.entries(this.fieldChanges).reduce(((t,[e,s])=>(t[e]=s.newValue,t)),{})}constructor(t={}){super(),this.#r();const e=t[this.constructor.primaryField];if(e&&this.constructor._instanceCache.has(e)){const s=this.constructor._instanceCache.get(e);return s.assign(t),s}this.assign(t)}#r(){Object.entries(this.constructor.fields).forEach((([t,e])=>{var s;"object"==typeof e?({type:s}=e):s=e;const i=`#${t}`;this[i]=void 0,Object.defineProperty(this,t,{get(){return this[i]},set(e){const n=this[i];this[i]=this.constructor._castFieldValue(e,s),this[i]!==n&&(this.fieldChanges[t]?this.fieldChanges[t].newValue=e:this.fieldChanges[t]={oldValue:n,newValue:e})},enumerable:!0,configurable:!0})}))}static async all(t={}){let e;if(this.endpoint){var s=this.endpoint;Object.entries(t).forEach((([t,e])=>s=s.replace(`:${t}`,String(e)))),e=await api.get(s)}else e=[...this._instanceCache.values()];return new Collection(this).fromArray(e)}async save(){if(!this.endpoint)return this.assign();let t;this.primaryKey?Object.keys(this.fieldChanges).length&&(t=await api.patch(`${this.endpoint}/${this.primaryKey}`,this.changeDelta)):t=await api.post(this.endpoint,this),t&&this.assign(t)}revert(...t){Object.keys(this.fieldChanges).length&&(Object.entries(this.fieldChanges).forEach((([e,s])=>{(0==t.length||t.includes(e))&&(this[e]=s.oldValue,delete this.fieldChanges[e])})),this.dispatchEvent(ModelEvent.change(this,this.changeDelta)))}async delete(){this.primaryKey&&this.constructor._instanceCache.delete(this.primaryKey),this.primaryKey&&this.endpoint&&await api.delete(`${this.endpoint}/${this.primaryKey}`);const t=ModelEvent.delete(this);this.dispatchEvent(t),this.constructor.dispatchEvent(t)}assign(t={}){Object.keys(this.constructor.fields).forEach((e=>{e in t&&(this[e]=t[e])}));const e=t[this.constructor.primaryField];e&&!this.constructor._instanceCache.has(e)&&(this.constructor._instanceCache.set(e,this),this.constructor.dispatchEvent(ModelEvent.new(this))),Object.keys(this.fieldChanges).length&&this.dispatchEvent(ModelEvent.change(this,this.changeDelta)),this.fieldChanges={}}get endpoint(){if(this.constructor.endpoint){var t=this.constructor.endpoint;return Object.keys(this.constructor.fields).forEach((e=>{t=t.replace(`:${e}`,String(this[e]))})),t}}get primaryKey(){return this[this.constructor.primaryField]}static get primaryField(){const t=Object.keys(this.fields).find((t=>this.fields[t].primaryKey));if(t)return t;if("id"in this.fields)return"id";throw new Error("Model must have a primary key or 'id' field defined.")}static dispatchEvent(t){this._classEventTarget.dispatchEvent(t)}static addEventListener(t,e){this._classEventTarget.addEventListener(t,e)}static removeEventListener(t,e){this._classEventTarget.removeEventListener(t,e)}static _castFieldValue(t,e){if(null==t)return t;switch(e){case Date:return new Date(t);case Number:case String:case Boolean:return e(t);default:return t}}toJSON(){const t={};return Object.keys(this.constructor.fields).forEach((e=>{const s=this[e];null!=s&&(t[e]=s instanceof Date?s.toISOString():s)})),t}}class ModelEvent extends CustomEvent{static NEW="new";static CHANGE="change";static DELETE="delete";constructor(t,e){const s=[ModelEvent.NEW,ModelEvent.CHANGE,ModelEvent.DELETE];if(!s.includes(t))throw new Error(`Invalid event type: ${t}. Valid types are ${s.join(", ")}.`);super(t,{detail:e,bubbles:!0})}static new(t){return new ModelEvent(ModelEvent.NEW,t)}static delete(t){return new ModelEvent(ModelEvent.DELETE,t)}static change(t,e){return new ModelEvent(ModelEvent.CHANGE,{target:t,delta:e})}}class Templater{static clone(t){if("string"==typeof t&&(t=document.querySelector(t)),!(t&&t instanceof HTMLTemplateElement))throw new Error(`Templater: No valid HTMLTemplateElement found for selector/input: ${t}`);return t.content.cloneNode(!0)}static bind(t,e){const s=e=>":this"===e.trim()?[t]:(e.trim().startsWith(":this")&&(e=e.replace(":this","")),t.querySelectorAll(e));Object.entries(e).forEach((([t,e])=>{t.split(/,(?![^(]*\))/g).map((t=>t.trim())).forEach((i=>{const n=i.match(/^(.*?)::([a-zA-Z]+)\s*(.*)$/);if(n){const[,i,a,r]=n,o=[i,r].join(" "),l=s(i);l.length>0?l.forEach((i=>{if(i._eventListeners||(i._eventListeners=new Set),!i._eventListeners.has(t)){const n=s(o)[0]||i;i.addEventListener(a,(t=>e(n,t))),i._eventListeners.add(t)}})):console.warn(`Templater: Event target element(s) not found for base selector: "${i}"`)}else{const t=s(i);t.length>0?t.forEach((t=>e(t))):console.warn(`Templater: Data binding target element(s) not found for selector: "${i}"`)}}))}))}}class Router{static routes=[];static defaultPath="/";static route(t,e){this.routes.push({path:t,callback:e})}static go(t,e=!1){e?history.replaceState({},"",t):history.pushState({},"",t),this.#o(t)}static init(){this.#o(),window.addEventListener("popstate",(()=>this.#o()))}static#o(t){const e=this.#l(t||window.location.pathname);if(!e)return this.go(this.defaultPath,!0);e.callback(e.params,e.queryParams)}static#l(t){for(const e of this.routes){const s=this.#c(t,e.path);if(s)return{...e,params:s.params,queryParams:s.queryParams}}return null}static#c(t,e){const[s,i]=t.split("?"),n=new URLSearchParams(i),a=s.split("/").filter(Boolean),r=e.split("/").filter(Boolean);if(a.length!==r.length)return null;const o={};for(let t=0;t<a.length;t++)if(r[t].startsWith(":")){o[r[t].slice(1)]=a[t]}else if(a[t]!==r[t])return null;return{params:o,queryParams:n}}}class API{static baseUrl="/api";static set baseUrl(t){this.baseUrl=t}static async request(t,e={}){var s=(t.startsWith("/")?this.baseUrl:"")+t;["DELETE","PATCH"].includes(e.method)||(s=s.endsWith("/")?s:s+"/");const i=await fetch(s,{headers:{"Content-Type":"application/json"},...e});if(!i.ok)throw new Error(`API Error: ${i.status} - ${await i.text()}`);return i.json()}static get(t){return this.request(t)}static post(t,e){return this.request(t,{method:"POST",body:JSON.stringify(e)})}static patch(t,e){return this.request(t,{method:"PATCH",body:JSON.stringify(e)})}static delete(t){return this.request(t,{method:"DELETE"})}static postFile(t,e){return this.request(t,{method:"POST",body:e,headers:{}})}}